{% from 'macros.paginator' import paginator %}
{% macro trclass(submission) %}

{% if cUser.admin %}
 {% if submission.testing_stage == 0 %}
 sub_wait
 {% elif submission.testing_stage == 4 %}
 sub_public_testing
 {% elif submission.testing_stage == 8 %}
 sub_wait_nonpublic_testing
 {% elif submission.testing_stage == 12 %}
 sub_nonpublic_testing
 {% endif %}
{% endif %}
{% endmacro %}

{% macro status(submission, td=false) %}
{% if td %}
  <td class="{{ submission.statuscolor }}">{{ submission.statusname }}</td>
{%else%}
  <a href="{{ 'SubmissionController.show' | action({id: submission.id}) }}" class="{{ submission.statuscolor }}">
    {{ submission.statusname }}
  </a>
{% endif %}
{% endmacro %}

{% macro score(submission) %}
{% if submission.status >= 2 %}
  {% if submission.assignment.score_visibility >= 4 %}
    {% if submission.score or submission.score==0 %}
        {{ "**" if submission.testing_stage != 16 else "" }}{{ submission.score }}/{{ submission.maxscore }}
    {%endif%}
  {% else %}
    {% if submission.public_score or submission.public_score==0 %}**{{ submission.public_score }}/{{ submission.public_maxscore }}{%endif%}
    {% if cUser.admin %}
      {% if submission.score or submission.score==0 %}
        <span style="font-style: italic; font-weight: normal;">
          ({{ submission.score }}/{{ submission.maxscore }})
        </span>
      {%endif%}
    {% endif %}
  {% endif %}
{% endif %}
{% endmacro %}

{% macro memory(submission) %}
{% if submission.status >= 2 %}
  {% if submission.assignment.score_visibility  >= 4 %}
    {{ (submission.maxmemory / 1024 / 1024) | round() }}Mb
  {% else %}
    **{{ (submission.public_maxmemory / 1024 / 1024) | round() }}Mb
    {% if cUser.admin %}
    ({{ (submission.maxmemory / 1024 / 1024) | round() }}Mb)
    {% endif %}
  {% endif %}
{% endif %}
{% endmacro %}

{% macro time(submission) %}
{% if submission.status >= 2 %}
  {% if submission.assignment.score_visibility >= 4 %}
    {{submission.maxtime}}s
  {% else %}
    **{{submission.public_maxtime | round(2)}}s
    {% if cUser.admin %}
    ({{submission.maxtime | round(2) }}s)
    {% endif %}
  {% endif %}
{% endif %}
{% endmacro %}

{% macro filesize(submission) %}
{{ ( submission.file.size / 1024 ) | round(2) }}kB
{% endmacro %}

{% macro show(test, assignment) %}
  {% set visible = (test.visible or assignment.score_visibility>=8) %}
  {% if cUser.admin or visible %}
     <tr class="initial{{ " partially_hidden" if not visible else ""}}">
      <td>{{ "** " if test.visible else "" }}{{ test.test.tid }}</td>
      <td>{{ test.test.gid }}</td>
      <td class="cc_sub {{ "c_OK" if test.status=="OK" else "c_CE" }}">
          {{ test.status }}
      </td>
      <td>{{ test.score }}</td>
      <td>{{ ( test.memory / 1024 / 1024 ) | round(2) }}MB</td>
      <td>{{ test.time | float | round(2) }}</td>
    </tr>
    {% set detailed = (test.visible or assignment.score_visibility >= 12) %}
    {% if cUser.admin or detailed %}
    <tr class="{{ "partially_hidden" if not detailed else "" }}">
        <td colspan=2 class="text-right">{{ antl.formatMessage('messages.message') }}</td>
        <td colspan=4 class="message"><pre class="simple">{{ test.public or " "}}</pre></td>
    </tr>
      {% if test.visible %}
      <tr class="{{ "partially_hidden" if not detailed else "" }}">
          <td colspan=2 class="text-right">{{ antl.formatMessage('messages.stderr') }}</td>
          <td colspan=4 class="message"><pre class="simple">{{ (test.stderr or " ") | truncate(5000, true) }}</pre></td>
      </tr>
      {% endif %}
    {% endif %}
    {% if cUser.admin %}
      <tr class="partially_hidden">
        <td colspan=2 class="text-right">{{ antl.formatMessage('messages.private') }}</td>
        <td colspan=4 class="message"><pre class="simple">{{ test.private or " " }}</pre></td>
      </tr>
    {% endif %}
  {% endif %}
{% endmacro %}

{% macro showSubmissionList(sub_paginated, controller_action, action_parameters) %}
  <div class="pull-right bold">**Publiskie testi</div>
  <table class="table">
    <thead>
      <tr>
        <th>{{ antl.formatMessage('messages.id') }}</th>
        <th>{{ antl.formatMessage('messages.group') }}</th>
        <th>{{ antl.formatMessage('messages.user') }}</th>
        <th>{{ antl.formatMessage('messages.time') }}</th>
        <th>{{ antl.formatMessage('messages.task') }}</th>
        <th>{{ antl.formatMessage('messages.status') }}</th>
        <th>{{ antl.formatMessage('messages.result') }}</th>
        <th>{{ antl.formatMessage('messages.memory') }}</th>
        <th>{{ antl.formatMessage('messages.time') }}</th>
      </tr>
    </thead>
    <tbody>
      {% for submission in sub_paginated.data %}
        <tr class="{{trclass(submission) | striptags}}">
          <td>
            <a href="{{ 'SubmissionController.show' | action({id: submission.id}) }}">
              {{ submission.id }}
            </a>
          </td>
          <td>
            <a href="{{ 'GroupController.show' | action({id: submission.assignment.group.id }) }}">
              {{ submission.assignment.group.name }}
            </a>
          </td>
          <td>
            {% if cUser.admin %}
              <a href="{{ 'UserController.show' | action({user_id : submission.user.id}) }}" >
                {{ submission.user.email }}
              </a>
            {% else %}
              {{ submission.user.email }}
            {% endif %}
          </td>
          <td>
            <a href="{{ 'SubmissionController.show' | action({id: submission.id}) }}">
              {{ submission.created_at }}
            </a>
          </td>
          <td>
            <a href="{{ 'AssignmentController.show' | action({assignment_id: submission.assignment.id }) }}">
              {{ submission.assignment.problem.name }}
            </a>
          </td>
          <td>
            {{ status(submission) }}
          </td>
          <td class="c_score">
            {{ score(submission) }}
          </td>
          <td>
            {{ memory(submission) }}
          </td>
          <td>
            {{ time(submission) }}
          </td>
        </tr>
      {% endfor %}
      {% if sub_paginated.total == 0 %}
        <tr>
          <td colspan=9>
            Jūs neesat veicis nevienu iesūtījumu.
          </td>
        </td>
      {% endif %}
    </tbody>
  </table>
  {{ paginator(sub_paginated, controller_action, action_parameters) }}
  {% if cUser.admin and sub_paginated.total %}
    <div style="float:right;">
      <div>
        <div class='rectangle sub_wait border'>
        </div>
        Gaida testēšanu
      </div>
      <div>
        <div class='rectangle sub_public_testing border'>
        </div>
        Publisko testu testēšana
      </div>
      <div>
        <div class='rectangle sub_wait_nonpublic_testing border'>
        </div>
        Pabeigta publisko testu testēšana
      </div>
      <div>
        <div class='rectangle sub_nonpublic_testing border'>
        </div>
        Ne publisko testu testēšana
      </div>
      <div>
        <div class='rectangle border'>
        </div>
        Testēšana pabeigta
      </div>
    </div>
  {% endif %}
{% endmacro %}
